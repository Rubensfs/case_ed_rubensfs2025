resources:
  jobs:
    Pipeline_INPE_FocosQueimadas_Stream_Online:
      name: Pipeline_INPE_FocosQueimadas_Stream_Online
      description: Pipeline ONLINE (quase real-time) INPE Focos Queimadas — RAW → BRONZE(Streaming) → SILVER → GOLD

      # ============================================================
      # SCHEDULE – EXECUTA A CADA 30 MINUTOS
      # ============================================================
      schedule:
        quartz_cron_expression: "0 0/30 * * * ?"
        timezone_id: America/Sao_Paulo
        pause_status: UNPAUSED

      # ============================================================
      # TASKS
      # ============================================================
      tasks:

        # ------------------------------
        # 1) RAW DOWNLOAD 10-MIN
        # ------------------------------
        - task_key: job_inpe_raw_download
          notebook_task:
            notebook_path: /Workspace/prj_amazonia_mon/notebooks/API/INPE_Raw_Download
            base_parameters:
              DATA_ALVO: "{{job.parameters.DATA_ALVO}}"
          job_cluster_key: Stream_Cluster
          max_retries: 1
          min_retry_interval_millis: 0
          description: Baixa CSV do INPE (10 minutos) e grava na camada RAW

        # ------------------------------
        # 2) BRONZE STREAM
        # ------------------------------
        - task_key: job_inpe_bronze_stream
          depends_on:
            - task_key: job_inpe_raw_download
          notebook_task:
            notebook_path: /Workspace/prj_amazonia_mon/notebooks/bronze/INPE_Bronze_Stream
            base_parameters:
              DATA_ALVO: "{{job.parameters.DATA_ALVO}}"
          job_cluster_key: Stream_Cluster
          max_retries: 1
          min_retry_interval_millis: 0
          description: Ingestão contínua Streaming da RAW → Bronze

        # ------------------------------
        # 3) SILVER PROCESS
        # ------------------------------
        - task_key: job_inpe_silver_process
          depends_on:
            - task_key: job_inpe_bronze_stream
          notebook_task:
            notebook_path: /Workspace/prj_amazonia_mon/notebooks/silver/INPE_Silver_Focoq_Process_ByOnline
            base_parameters:
              DATA_ALVO: "{{job.parameters.DATA_ALVO}}"
          job_cluster_key: Stream_Cluster
          max_retries: 1
          min_retry_interval_millis: 0
          description: Sanitiza e processa dados Bronze → Silver

        # ------------------------------
        # 4) GOLD AGGREGATION
        # ------------------------------
        - task_key: job_inpe_gold_aggregation
          depends_on:
            - task_key: job_inpe_silver_process
          notebook_task:
            notebook_path: /Workspace/prj_amazonia_mon/notebooks/gold/INPE_Gold_Agg_FocoQ_ByOnline
            base_parameters:
              DATA_ALVO: "{{job.parameters.DATA_ALVO}}"
          job_cluster_key: Stream_Cluster
          max_retries: 1
          min_retry_interval_millis: 0
          description: Agregação (UF/Bioma) da Silver → GOLD

      # ============================================================
      # CLUSTER STREAMING (COMPARTILHADO ENTRE AS TASKS)
      # ============================================================
      job_clusters:
        - job_cluster_key: Stream_Cluster
          new_cluster:
            spark_version: 14.3.x-scala2.12
            node_type_id: Standard_DS3_v2
            num_workers: 2
            data_security_mode: SINGLE_USER
            runtime_engine: STANDARD
            enable_elastic_disk: true
            spark_conf:
              spark.databricks.delta.preview.enabled: "true"
              spark.sql.shuffle.partitions: "4"
            custom_tags:
              project: INPE_FOCOS_STREAM

      # ============================================================
      # QUEUE E PARAMETROS GLOBAIS
      # ============================================================
      queue:
        enabled: true

      parameters:
        - name: DATA_ALVO
          default: "{{job.trigger.time.iso_date}}"