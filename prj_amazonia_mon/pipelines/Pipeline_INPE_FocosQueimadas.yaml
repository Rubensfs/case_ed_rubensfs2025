resources:
  jobs:
    Pipeline_INPE_FocosQueimadas:
      name: Pipeline_INPE_FocosQueimadas
      format: MULTI_TASK
      description: "Pipeline completo INPE Focos Queimadas (RAW ‚Üí BRONZE ‚Üí SILVER ‚Üí GOLD)"

      # =====================================================
      # üîÅ AGENDAMENTO AUTOM√ÅTICO - 07:00 (Hor√°rio de Bras√≠lia)
      # =====================================================
      schedule:
        quartz_cron_expression: "0 0 7 * * ?"   # executa todos os dias √†s 07:00
        timezone_id: "America/Sao_Paulo"
        pause_status: "UNPAUSED"

      # =====================================================
      # üî¢ PAR√ÇMETROS GLOBAIS
      # =====================================================
      parameters:
        - name: data_ref_global
          default: "{{current_date('yyyy-MM-dd')}}"
          description: "Data de refer√™ncia global (formato yyyy-MM-dd, gerada automaticamente no dia da execu√ß√£o)"

      # =====================================================
      # ‚öôÔ∏è CLUSTER COMPARTILHADO
      # =====================================================
      job_clusters:
        - job_cluster_key: Shared_Cluster
          new_cluster:
            spark_version: 14.3.x-scala2.12
            node_type_id: Standard_DS3_v2
            num_workers: 1
            data_security_mode: SINGLE_USER
            runtime_engine: STANDARD

      # =====================================================
      # üß© TAREFAS DO PIPELINE
      # =====================================================
      tasks:
        # 1Ô∏è‚É£ Captura do CSV Di√°rio - RAW
        - task_key: job_capture_csv_inpe
          description: "Baixa o arquivo CSV di√°rio de focos de queimadas do INPE e grava na camada RAW"
          job_cluster_key: Shared_Cluster
          notebook_task:
            notebook_path: /Workspace/Jobs/Raw/job_capture_csv_inpe
            base_parameters:
              data_ref: "${var.data_ref_global}"
              url_csv: ""
              destino: "/Volumes/datamasters/raw/raw_inpe"
          max_retries: 1

        # 2Ô∏è‚É£ Ingest√£o - BRONZE
        - task_key: job_d_ingesta_foco_queim
          description: "L√™ o CSV da camada RAW e grava na tabela Bronze"
          depends_on:
            - task_key: job_capture_csv_inpe
          job_cluster_key: Shared_Cluster
          notebook_task:
            notebook_path: /Workspace/Jobs/Bronze/job_d_ingesta_foco_queim
            base_parameters:
              catalog: "datamasters"
              schema: "b_tbra"
              table: "focos_queimadas_diario"
              path_raw: "/Volumes/datamasters/raw/raw_inpe"
              data_ref_carga: "${var.data_ref_global}"
          max_retries: 1

        # 3Ô∏è‚É£ Processamento - SILVER
        - task_key: job_d_foco_queim_inc_silver
          description: "L√™ a tabela Bronze e aplica sanitiza√ß√£o, grava na tabela Silver"
          depends_on:
            - task_key: job_d_ingesta_foco_queim
          job_cluster_key: Shared_Cluster
          notebook_task:
            notebook_path: /Workspace/Jobs/Silver/job_d_foco_queim_inc_silver
            base_parameters:
              catalog: "datamasters"
              schema_bronze: "b_tbra"
              table_bronze: "focos_queimadas_diario"
              schema_silver: "s_tbra"
              table_silver: "focos_queimadas_diario"
              data_ref_carga: "${var.data_ref_global}"
          max_retries: 1

        # 4Ô∏è‚É£ Agrega√ß√£o - GOLD
        - task_key: job_d_foco_queim_gold_agregado
          description: "Agrega dados da camada Silver em m√©tricas di√°rias (por UF e Bioma)"
          depends_on:
            - task_key: job_d_foco_queim_inc_silver
          job_cluster_key: Shared_Cluster
          notebook_task:
            notebook_path: /Workspace/Jobs/Gold/job_d_foco_queim_gold_agregado
            base_parameters:
              catalog: "datamasters"
              schema_silver: "s_tbra"
              table_silver: "focos_queimadas_diario"
              schema_gold: "g_tbra"
              table_gold: "focos_queimadas_agg_diario"
              data_ref_carga: "${var.data_ref_global}"
          max_retries: 1