name: Pipeline_INPE_FocosQueimadas
format: MULTI_TASK

parameters:
  - name: data_ref_global
    default: "20251101"
    description: "Data de referência global (formato AAAAMMDD)"

job_clusters:
  - job_cluster_key: Shared_Cluster
    new_cluster:
      spark_version: 14.3.x-scala2.12
      node_type_id: Standard_DS3_v2
      num_workers: 1
      data_security_mode: SINGLE_USER
      runtime_engine: STANDARD

tasks:
  # =====================================================
  # 1️⃣ Captura do CSV Diário - RAW
  # =====================================================
  - task_key: job_capture_csv_inpe
    description: "Baixa o arquivo CSV diário de focos de queimadas do INPE e grava na camada RAW"
    job_cluster_key: Shared_Cluster
    notebook_task:
      notebook_path: /Workspace/Jobs/Raw/job_capture_csv_inpe
      base_parameters:
        data_ref: "${var.data_ref_global}"
        url_csv: ""
        destino: "/Volumes/datamasters/raw/raw_inpe"
    max_retries: 1

  # =====================================================
  # 2️⃣ Ingestão - BRONZE
  # =====================================================
  - task_key: job_d_ingesta_foco_queim
    description: "Lê o CSV da camada RAW e grava na tabela Bronze"
    depends_on:
      - task_key: job_capture_csv_inpe
    job_cluster_key: Shared_Cluster
    notebook_task:
      notebook_path: /Workspace/Jobs/Bronze/job_d_ingesta_foco_queim
      base_parameters:
        catalog: "datamasters"
        schema: "b_tbra"
        table: "focos_queimadas_diario"
        path_raw: "/Volumes/datamasters/raw/raw_inpe"
        data_ref_carga: "${var.data_ref_global:yyyy-MM-dd}"
    max_retries: 1

  # =====================================================
  # 3️⃣ Processamento - SILVER
  # =====================================================
  - task_key: job_d_foco_queim_inc_silver
    description: "Lê a tabela Bronze e aplica sanitização, grava na tabela Silver"
    depends_on:
      - task_key: job_d_ingesta_foco_queim
    job_cluster_key: Shared_Cluster
    notebook_task:
      notebook_path: /Workspace/Jobs/Silver/job_d_foco_queim_inc_silver
      base_parameters:
        catalog: "datamasters"
        schema_bronze: "b_tbra"
        table_bronze: "focos_queimadas_diario"
        schema_silver: "s_tbra"
        table_silver: "focos_queimadas_diario"
        data_ref_carga: "${var.data_ref_global:yyyy-MM-dd}"
    max_retries: 1

  # =====================================================
  # 4️⃣ Agregação - GOLD
  # =====================================================
  - task_key: job_d_foco_queim_gold_agregado
    description: "Agrega dados da camada Silver em métricas diárias (por UF e Bioma)"
    depends_on:
      - task_key: job_d_foco_queim_inc_silver
    job_cluster_key: Shared_Cluster
    notebook_task:
      notebook_path: /Workspace/Jobs/Gold/job_d_foco_queim_gold_agregado
      base_parameters:
        catalog: "datamasters"
        schema_silver: "s_tbra"
        table_silver: "focos_queimadas_diario"
        schema_gold: "g_tbra"
        table_gold: "focos_queimadas_agg_diario"
        data_ref_carga: "${var.data_ref_global:yyyy-MM-dd}"
    max_retries: 1
