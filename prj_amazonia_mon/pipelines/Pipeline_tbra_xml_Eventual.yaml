resources:
  jobs:
    Pipeline_tbra_xml_Eventual:
      name: Pipeline_tbra_xml_Eventual
      description: Pipeline completa PRODES / TerraBrasilis (RAW → BRONZE → SILVER → GOLD)

      git_source:
        git_url: https://github.com/Rubensfs/case_ed_rubensfs2025.git
        git_provider: gitHub
        git_branch: main

      tasks:
        # =========================================================
        # RAW — Download XML TerraBrasilis
        # =========================================================
        - task_key: ingesta_raw_xml
          notebook_task:
            notebook_path: prj_amazonia_mon/notebooks/API/INPE_Raw_Download_xml
            source: GIT
            base_parameters:
              catalog: datamasters
              data_ref_carga: "{{job.parameters.data_ref_carga}}"
              uuid_metadata: "{{job.parameters.uuid_metadata}}"
              file_prefix: "{{job.parameters.file_prefix}}"
          job_cluster_key: Shared_Cluster
          description: Baixa XML TerraBrasilis e salva na RAW

        # =========================================================
        # BRONZE — Ingestão XML
        # =========================================================
        - task_key: process_bronze
          depends_on:
            - task_key: ingesta_raw_xml
          notebook_task:
            notebook_path: prj_amazonia_mon/notebooks/bronze/ingesta_raw_xml
            source: GIT
            base_parameters:
              catalog: datamasters
              schema: b_tbra
              table: "{{job.parameters.file_prefix}}"
              path_raw: /Volumes/datamasters/raw/raw_tbra
              data_ref_carga: "{{job.parameters.data_ref_carga}}"
          job_cluster_key: Shared_Cluster
          libraries:
            - maven:
                coordinates: com.databricks:spark-xml_2.12:0.17.0
          description: Lê XML RAW e grava tabela Bronze

        # =========================================================
        # SILVER — Processamento
        # =========================================================
        - task_key: process_silver
          depends_on:
            - task_key: process_bronze
          notebook_task:
            notebook_path: prj_amazonia_mon/notebooks/silver/process_silver_xml
            source: GIT
            base_parameters:
              catalog: datamasters
              data_ref_carga: "{{job.parameters.data_ref_carga}}"
              schema: b_tbra
              table: "{{job.parameters.file_prefix}}"
              schema_out: s_tbra
              table_out: "{{job.parameters.file_prefix}}_process"
          job_cluster_key: Shared_Cluster
          description: Bronze → Silver

        # =========================================================
        # GOLD — Agregação final
        # =========================================================
        - task_key: process_gold
          depends_on:
            - task_key: process_silver
          notebook_task:
            notebook_path: prj_amazonia_mon/notebooks/gold/e_tbras_xml_gold_valor
            source: GIT
            base_parameters:
              catalog: datamasters
              data_ref_carga: "{{job.parameters.data_ref_carga}}"
              schema_in: s_tbra
              table_in: "{{job.parameters.file_prefix}}_process"
              schema_out: g_tbra
              table_out: "{{job.parameters.file_prefix}}_valor"
          job_cluster_key: Shared_Cluster
          description: Silver → Gold

      # =========================================================
      # CLUSTER DO JOB
      # =========================================================
      job_clusters:
        - job_cluster_key: Shared_Cluster
          new_cluster:
            spark_version: 14.3.x-scala2.12
            node_type_id: Standard_DS3_v2
            num_workers: 1
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            runtime_engine: STANDARD

      queue:
        enabled: true

      parameters:
        - name: catalog
          default: datamasters
        - name: data_ref_carga
          default: "{{job.trigger.time.iso_date}}"
        - name: uuid_metadata
          default: fe02f2bf-2cc0-49d5-ab72-a3954f997408
        - name: file_prefix
          default: prodes_brasil
